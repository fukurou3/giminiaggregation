✅ Next.js（React） + Firebase 開発指示書（爆速 & 安定）
🏗 技術スタック
項目	技術
フロントエンド	Next.js (React) + TypeScript（TSX）
バックエンド	Firebase SDK（Auth / Firestore / Storage）
状態管理	Zustand または React Context（Redux不要）
バリデーション	zod + react-hook-form（フォーム連携）
スタイリング	Tailwind CSS（推奨）
デプロイ	フロント：Vercel / バックエンド：Firebase
SSR	使用しない（CSRで統一）

📁 ## ディレクトリ構成（MVP テンプレ）

```text
my-canvas-app/
├── pages/ or app/            # Next.js ページ
│   ├── index.tsx             # 投稿一覧
│   ├── new.tsx               # 投稿フォーム
│   └── [id].tsx              # 詳細ページ
├── components/               # 再利用 UI 部品
│   └── PostCard.tsx
├── lib/                      # 初期化・共通ロジック
│   ├── firebase.ts           # SDK 初期化
│   ├── auth.ts               # 認証処理
│   └── store.ts              # Zustand ストア
├── types/                    # 型定義
│   └── Post.ts
├── utils/                    # 汎用ユーティリティ
│   └── validate.ts           # zod スキーマ
├── public/                   # 静的ファイル
├── .env.local                # 環境変数
├── .env.local.example        # 共有用サンプル
├── firebase.json             # Firebase 設定（任意）
├── firestore.rules           # セキュリティルール
└── README.md                 # プロジェクト概要
```

🧠## 型とスキーマ例

```ts
// types/Post.ts
import { Timestamp } from "firebase/firestore";
export type Post = {
  id: string;
  title: string;
  url: string;
  tags: string[];
  authorId: string;
  createdAt: Timestamp;
};

// lib/schemas/postSchema.ts
import { z } from "zod";
export const postSchema = z.object({
  title: z.string().min(1),
  url: z.string().url(),
  tags: z.array(z.string()),
});
```

---

## よくある罠と対策

1. **SDK 初期化の重複**（initializeApp 複数呼び出し）

   ```ts
   import { initializeApp, getApps, getApp } from "firebase/app";
   const app = getApps().length ? getApp() : initializeApp(config);
   ```
2. **環境変数未設定** (`NEXT_PUBLIC_` 接頭辞忘れ)

   * `.env.local` に必ず `NEXT_PUBLIC_FIREBASE_*` を定義し、`.env.local.example` を共有
3. **NoSQL スキーマレス地獄**

   * zod スキーマでバリデーション → react-hook-form と統合
4. **認証状態のちらつき**

   ```ts
   const [user, loading] = useAuthState(auth);
   if (loading) return <Spinner />;
   if (!user) return <Login />;
   ```
5. **Firebase Auth の SSR 非対応**

   * `getServerSideProps` や SSR は使わず完全 CSR
6. **Hosting ルーティング破綻**

   * Vercel でホストし、firebase.json rewrites は不要
7. **本番環境で死ぬ原因**

   * `.env.local` 未設定、ルール未定義 → `firestore.rules` を必ず用意

---

## 開発 7 ヶ条

1. `lib/firebase.ts` に初期化を一元化
2. クライアント環境変数は必ず `NEXT_PUBLIC_` で
3. バリデーションは zod + react-hook-form
4. Auth 状態は `useAuthState()` + Zustand で管理
5. SSR をやらない（CSR 統一）
6. Firebase Hosting ではなく Vercel を使う
7. `.env.local.example` と `firestore.rules` は必須

---

## 認証・投稿例

```ts
// lib/auth.ts
import { GoogleAuthProvider, signInWithPopup } from "firebase/auth";
export const loginWithGoogle = async () => {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};

// 投稿登録
import { db } from "@/lib/firebase";
import { collection, addDoc, serverTimestamp } from "firebase/firestore";
await addDoc(collection(db, "posts"), {
  title,
  url,
  tags,
  createdAt: serverTimestamp(),
  authorId: user.uid,
});
```

---

## 最終補足：メリット

* 🎯 **MVP 最適化**: 速攻構築で迷いなく一人完結
* 🔐 **安全性**: 型・認証・ルールで堅牢
* 📦 **将来展開**: Flutter/React Native/SSR 移行容易
* 🌐 **簡易デプロイ**: Vercel × Firebase でワンクリック公開
